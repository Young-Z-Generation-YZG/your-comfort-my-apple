@startuml UC1_Register
actor Actor
boundary SignUpPage
control AuthController
control RegisterHandler
control IdentityService
control KeycloakService
control OtpGenerator
control CachedRepository
control EmailService
database DB

Actor -> SignUpPage: 1. input(email, password, \nconfirm_password, \nfirst_name, last_name, \nphone_number, birth_day, country)
activate Actor
activate SignUpPage
SignUpPage -> AuthController: 2. register(request)
activate AuthController
AuthController -> RegisterHandler: 3. register(request)
activate RegisterHandler
RegisterHandler -> IdentityService: 4. FindUserByEmail(email)
activate IdentityService
IdentityService --> RegisterHandler: 5. return Result(user)
deactivate IdentityService
alt user already exists
    RegisterHandler --> AuthController: 5.1 return Errors.User.AlreadyExists
    AuthController --> SignUpPage: 5.2 return Error(message)
    SignUpPage --> Actor: 5.3 message("Email already exists")
else user not found
    RegisterHandler -> KeycloakService: 6. CreateKeycloakUser(userRepresentation)
    activate KeycloakService
    KeycloakService --> RegisterHandler: 7. return Result(keycloakUserId)
    deactivate KeycloakService
    alt keycloak user created
        RegisterHandler -> IdentityService: 8. CreateUser(request, keycloakUserId)
        activate IdentityService
        IdentityService -> DB: 9. SaveUser(user)
        activate DB
        DB --> IdentityService: 10. return Result(userRecord)
        deactivate DB
        IdentityService --> RegisterHandler: 11. return Result(createResult)
        deactivate IdentityService
        alt identity user created
            RegisterHandler -> OtpGenerator: 12. GenerateOtp(6)
            activate OtpGenerator
            OtpGenerator --> RegisterHandler: 13. return otp
            deactivate OtpGenerator
            RegisterHandler -> CachedRepository: 14. Set(email, otp, 5 minutes)
            activate CachedRepository
            CachedRepository --> RegisterHandler: 15. return stored
            deactivate CachedRepository
            RegisterHandler -> IdentityService: 16. GenerateEmailVerificationToken(keycloakUserId)
            activate IdentityService
            IdentityService -> DB: 17. CreateEmailVerificationToken(keycloakUserId)
            activate DB
            DB --> IdentityService: 18. return Result(token)
            deactivate DB
            IdentityService --> RegisterHandler: 19. return Result(tokenResult)
            deactivate IdentityService
            alt token generated
                RegisterHandler -> EmailService: 20. SendEmail(emailCommand)
                activate EmailService
                alt email sent
                    EmailService --> RegisterHandler: 21. return sent
                    deactivate EmailService
                    RegisterHandler --> AuthController: 22. return EmailVerificationResponse(params, verificationType, ttl)
                    AuthController --> SignUpPage: 23. return EmailVerificationResponse
                    SignUpPage --> Actor: 24. message("Check your \nemail to verify account")
                else email sending failed
                    EmailService --> RegisterHandler: 21.1 return exception
                    RegisterHandler -> KeycloakService: 21.2 DeleteKeycloakUser(keycloakUserId)
                    RegisterHandler -> IdentityService: 21.3 DeleteUser(keycloakUserId)
                    RegisterHandler --> AuthController: 21.4 return Errors.User.FailedToRegister
                    AuthController --> SignUpPage: 21.5 return Error(message)
                    SignUpPage --> Actor: 21.6 message("Registration failed")
                end
            else email verification token generation failed
                RegisterHandler -> KeycloakService: 19.1 DeleteKeycloakUser(keycloakUserId)
                RegisterHandler -> IdentityService: 19.2 DeleteUser(keycloakUserId)
                RegisterHandler --> AuthController: 19.3 return Errors.User.FailedToRegister
                AuthController --> SignUpPage: 19.4 return Error(message)
                SignUpPage --> Actor: 19.5 message("Registration failed")
            end
        else identity user creation failed
            RegisterHandler -> KeycloakService: 11.1 DeleteKeycloakUser(keycloakUserId)
            RegisterHandler --> AuthController: 11.2 return Errors.User.FailedToRegister
            AuthController --> SignUpPage: 11.3 return Error(message)
            SignUpPage --> Actor: 11.4 message("Failed to register")
        end
    else keycloak user creation failed
        RegisterHandler -> KeycloakService: 7.1 DeleteKeycloakUser(keycloakUserId)
        RegisterHandler --> AuthController: 7.2 return Errors.User.FailedToRegister
        deactivate RegisterHandler
        AuthController --> SignUpPage: 7.3 return Error(message)
        deactivate AuthController
        SignUpPage --> Actor: 7.4 message("Failed to register")
        deactivate SignUpPage
        deactivate Actor
    end
end

@enduml