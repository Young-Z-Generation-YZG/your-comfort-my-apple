@startuml UC2_login
actor Actor
boundary HomePage
boundary SignInPage
control AuthController
control LoginHandler
control IdentityService
control KeycloakService
control OtpGenerator
control CachedRepository
control EmailService
database DB

Actor -> SignInPage: input(email,password)
activate Actor
activate SignInPage

SignInPage -> AuthController: login(request)
activate AuthController

AuthController -> LoginHandler: login(request)
activate LoginHandler

LoginHandler -> IdentityService: Login(request)
activate IdentityService
IdentityService --> LoginHandler: Result(user)
deactivate IdentityService

alt invalid credentials
    LoginHandler --> AuthController: return Errors.User.InvalidCredentials
    AuthController --> SignInPage: return Errors.User.InvalidCredentials
    SignInPage --> Actor: message("Invalid credentials")
else login success
    alt email not confirmed
        LoginHandler -> OtpGenerator: GenerateOtp(6)
        activate OtpGenerator
        OtpGenerator --> LoginHandler: otp
        deactivate OtpGenerator
        LoginHandler -> CachedRepository: Set(email, otp, 5 minutes)
        activate CachedRepository
        CachedRepository --> LoginHandler: stored
        deactivate CachedRepository
        LoginHandler -> IdentityService: GenerateEmailVerificationToken(userId)
        activate IdentityService
        IdentityService --> LoginHandler: Result(token)
        deactivate IdentityService
        alt token generation failed (user does not exist)
            LoginHandler --> AuthController: return Errors.User.DoesNotExist
            AuthController --> SignInPage: return Errors.User.DoesNotExist
            SignInPage --> Actor: message("User does not exist")
        else token generated
            LoginHandler -> EmailService: SendEmail(emailCommand)
            activate EmailService
            EmailService --> LoginHandler: sent
            deactivate EmailService
            LoginHandler --> AuthController: return LoginResponse(params, verificationType)
            AuthController --> SignInPage: return LoginResponse
            SignInPage --> Actor: message("Check your email to verify account")
        end
    else email confirmed
        LoginHandler -> KeycloakService: GetKeycloakTokenPair(email, password)
        activate KeycloakService
        KeycloakService --> LoginHandler: TokenPair(accessToken, refreshToken)
        deactivate KeycloakService

        LoginHandler --> AuthController: return LoginResponse(tokens)
        deactivate LoginHandler
        AuthController --> SignInPage: return LoginResponse(tokens)
        deactivate AuthController
        SignInPage -> HomePage: navigate()
        deactivate SignInPage
        activate HomePage
        HomePage --> Actor: display(HomePage)
        deactivate HomePage
        deactivate Actor
    end
end
@enduml