@startuml UC2_login
actor Actor
boundary HomePage
boundary SignInPage
control AuthController
control LoginHandler
control IdentityService
control KeycloakService
control OtpGenerator
control CachedRepository
control EmailService
database DB

Actor -> SignInPage: 1. input(email,password)
activate Actor
activate SignInPage

SignInPage -> AuthController: 2. login(request)
activate AuthController

AuthController -> LoginHandler: 3. login(request)
activate LoginHandler

LoginHandler -> IdentityService: 4. FindUserAsync(email)
activate IdentityService
IdentityService -> DB: 5. FindByEmailAsync(email)
activate DB
DB --> IdentityService: 6. return(user)
deactivate DB
IdentityService --> LoginHandler: 7. return Result(user)
deactivate IdentityService

alt user found
    LoginHandler -> IdentityService: 8. LoginAsync(user, password)
    activate IdentityService
    IdentityService --> LoginHandler: 9. return Result(valid)
    deactivate IdentityService

    alt login succeeded

        alt email confirmed
            LoginHandler -> KeycloakService: 10. GetKeycloakTokenPair(email, password)
            activate KeycloakService
            KeycloakService --> LoginHandler: 11. return TokenPair(accessToken, refreshToken)
            deactivate KeycloakService
            LoginHandler --> AuthController: 12. return LoginResponse(tokens)
            AuthController --> SignInPage: 13. return LoginResponse(tokens)
            SignInPage -> HomePage: 14. navigate()
            activate HomePage
            HomePage --> Actor: 15. display(HomePage)
            deactivate HomePage
        else email not confirmed
            LoginHandler -> OtpGenerator: 16. GenerateOtp(6)
            activate OtpGenerator
            OtpGenerator --> LoginHandler: 17. return otp
            deactivate OtpGenerator
            LoginHandler -> CachedRepository: 18. Set(email, otp, 5 minutes)
            activate CachedRepository
            CachedRepository --> LoginHandler: 19. return stored
            deactivate CachedRepository
            LoginHandler -> IdentityService: 20. GenerateEmailVerificationToken(userId)
            activate IdentityService
            IdentityService -> DB: 21. FindByIdAsync(userId)
            activate DB
            DB --> IdentityService: 22. return(user)
            deactivate DB
            IdentityService --> LoginHandler: 23. return Result(token)
            deactivate IdentityService

            alt token generated
                LoginHandler -> EmailService: 24. SendEmail(emailCommand)
                activate EmailService
                EmailService --> LoginHandler: 25. return sent
                deactivate EmailService
                LoginHandler --> AuthController: 26. return LoginResponse(params, verificationType)
                AuthController --> SignInPage: 27. return LoginResponse
                SignInPage --> Actor: 28. message("Check your email to verify account")
            else token generation failed
                LoginHandler --> AuthController: 23.1 return Errors.User.DoesNotExist
                AuthController --> SignInPage: 23.2 return Errors.User.DoesNotExist
                SignInPage --> Actor: 23.3 message("User does not exist")
            end
        end
    else login failed
        LoginHandler --> AuthController: 9.1 return Errors.User.InvalidCredentials
        AuthController --> SignInPage: 9.2 return Errors.User.InvalidCredentials
        SignInPage --> Actor: 9.3 message("Invalid credentials")
    end
else user not found
    LoginHandler --> AuthController: 7.1 return Errors.User.DoesNotExist
    deactivate LoginHandler
    AuthController --> SignInPage: 7.2 return Errors.User.DoesNotExist
    deactivate AuthController
    SignInPage --> Actor: 7.3 message("User does not exist")
    deactivate SignInPage
    deactivate Actor
end
@enduml