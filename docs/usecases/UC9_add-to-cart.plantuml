@startuml UC9_add_to_cart
actor Actor
boundary ProductDetailsPage
control CartController
control StoreBasketHandler
control UserHttpContext
control ModelSlugCache
control DistributedCache
control BasketRepository

Actor -> ProductDetailsPage: 1. selectVariant(color, model, storage)
activate Actor
activate ProductDetailsPage

ProductDetailsPage -> CartController: 2. storeBasket(color, model, storage, \nproductModelId)
activate CartController

CartController -> StoreBasketHandler: 3. storeBasket(command)
activate StoreBasketHandler

StoreBasketHandler -> UserHttpContext: 4. GetUserEmail()
activate UserHttpContext
UserHttpContext --> StoreBasketHandler: 5. return userEmail
deactivate UserHttpContext

StoreBasketHandler -> StoreBasketHandler: 6. ShoppingCartItemMapping(cartItems)

loop for each item in cartItems
    StoreBasketHandler -> DistributedCache: 7. GetString(GetIphoneSkuPriceKey(model, storage, color))
    activate DistributedCache
    DistributedCache --> StoreBasketHandler: 8. return unitPrice
    deactivate DistributedCache

    StoreBasketHandler -> DistributedCache: 9. GetString(GetDisplayImageUrlKey(modelId, color))
    activate DistributedCache
    DistributedCache --> StoreBasketHandler: 10. return displayImageUrl
    deactivate DistributedCache

    StoreBasketHandler -> ModelSlugCache: 11. GetSlug(modelId)
    activate ModelSlugCache
    ModelSlugCache --> StoreBasketHandler: 12. return modelSlug
    deactivate ModelSlugCache
end

StoreBasketHandler -> BasketRepository: 13. StoreBasketAsync(shoppingCart)
activate BasketRepository
BasketRepository --> StoreBasketHandler: 14. return Result(result)
deactivate BasketRepository

alt store succeeded
    StoreBasketHandler --> CartController: 15. return true
    CartController --> ProductDetailsPage: 16. return true
    ProductDetailsPage --> Actor: 17. message("Added to cart")
else store failed
    StoreBasketHandler --> CartController: 14.1 return Error(message)
    deactivate StoreBasketHandler
    CartController --> ProductDetailsPage: 14.2 return Error(message)
    deactivate CartController
    ProductDetailsPage --> Actor: 14.3 message("Failed to add to cart")
    deactivate ProductDetailsPage
    deactivate Actor
end

@enduml

