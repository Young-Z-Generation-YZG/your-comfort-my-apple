@startuml UC33_write_review
actor Actor
boundary ProductDetailsPage
control ReviewController
control CreateReviewHandler
control UserHttpContext
control SkuRepository
control ReviewRepository
database DB

Actor -> ProductDetailsPage: 1. submit review(skuId, orderId,\norderItemId, content, rating)
activate Actor
activate ProductDetailsPage

ProductDetailsPage -> ReviewController: 2. createReview(request)
activate ReviewController

ReviewController -> CreateReviewHandler: 3. createReview(request)
activate CreateReviewHandler

CreateReviewHandler -> UserHttpContext: 4. GetUserId()
activate UserHttpContext
UserHttpContext --> CreateReviewHandler: 5. return userId
deactivate UserHttpContext

CreateReviewHandler -> UserHttpContext: 6. GetUserEmail()
activate UserHttpContext
UserHttpContext --> CreateReviewHandler: 7. return userEmail
deactivate UserHttpContext

CreateReviewHandler -> SkuRepository: 8. GetByIdAsync(skuId)
activate SkuRepository
SkuRepository -> DB: 8. GetByIdAsync(skuId)
activate DB
DB --> SkuRepository: 9. return SKU | null
deactivate DB
SkuRepository --> CreateReviewHandler: 10. return SKU | null
deactivate SkuRepository

alt sku found
    CreateReviewHandler -> CreateReviewHandler: 11. Build OrderInfo(orderId, orderItemId)
    CreateReviewHandler -> CreateReviewHandler: 12. Build CustomerReviewInfo(name = userEmail || userId || \"Anonymous\")
    CreateReviewHandler -> CreateReviewHandler: 13. Create Review(modelId, skuId,\norderInfo, customerInfo, content, rating)

    CreateReviewHandler -> ReviewRepository: 14. InsertOneAsync(review)
    activate ReviewRepository
    ReviewRepository -> DB: 14. InsertOneAsync(review)
    activate DB
    DB --> ReviewRepository: 15. return inserted
    deactivate DB
    ReviewRepository --> CreateReviewHandler: 16. return Result(bool)
    deactivate ReviewRepository

    alt insert success
        CreateReviewHandler --> ReviewController: 17. return true
        ReviewController --> ProductDetailsPage: 18. return true
        ProductDetailsPage --> Actor: 19. message("Review submitted")
    else insert failed
        CreateReviewHandler --> ReviewController: 16.1 return false
        ReviewController --> ProductDetailsPage: 16.2 return false
        ProductDetailsPage --> Actor: 16.3 message("Failed to submit review")
    end
else sku not found
    CreateReviewHandler --> ReviewController: 10.1 return false
    deactivate CreateReviewHandler
    ReviewController --> ProductDetailsPage: 10.2 return false
    deactivate ReviewController
    ProductDetailsPage --> Actor: 10.3 message("Unable to find product for review")
    deactivate ProductDetailsPage
    deactivate Actor
end

@enduml

