@startuml UC33_write_review
actor Actor
boundary ProductDetailsPage
control ReviewController
control CreateReviewHandler
control UserHttpContext
control SkuRepository
control ReviewRepository
database DB

Actor -> ProductDetailsPage: 1. submit review(skuId, orderId,\norderItemId, content, rating)
activate Actor
activate ProductDetailsPage

ProductDetailsPage -> ReviewController: 2. createReview(request)
activate ReviewController

ReviewController -> CreateReviewHandler: 3. createReview(request)
activate CreateReviewHandler

CreateReviewHandler -> UserHttpContext: 4. GetUserId()
activate UserHttpContext
UserHttpContext --> CreateReviewHandler: 5. return userId
deactivate UserHttpContext

CreateReviewHandler -> UserHttpContext: 6. GetUserEmail()
activate UserHttpContext
UserHttpContext --> CreateReviewHandler: 7. return userEmail
deactivate UserHttpContext

CreateReviewHandler -> SkuRepository: 8. GetByIdAsync(skuId)
activate SkuRepository
SkuRepository -> DB: 8.1 GetByIdAsync(skuId)
activate DB
DB --> SkuRepository: 8.2 return SKU | null
deactivate DB
SkuRepository --> CreateReviewHandler: 9. return SKU | null
deactivate SkuRepository

alt sku found
    CreateReviewHandler -> CreateReviewHandler: 10. Build OrderInfo(orderId, orderItemId)
    CreateReviewHandler -> CreateReviewHandler: 11. Build CustomerReviewInfo(name = userEmail || userId || \"Anonymous\")
    CreateReviewHandler -> CreateReviewHandler: 12. Create Review(modelId, skuId,\norderInfo, customerInfo, content, rating)

    CreateReviewHandler -> ReviewRepository: 13. InsertOneAsync(review)
    activate ReviewRepository
    ReviewRepository -> DB: 13.1 InsertOneAsync(review)
    activate DB
    DB --> ReviewRepository: 13.2 return inserted
    deactivate DB
    ReviewRepository --> CreateReviewHandler: 14. return Result(bool)
    deactivate ReviewRepository

    alt insert success
        CreateReviewHandler --> ReviewController: 15. return true
        ReviewController --> ProductDetailsPage: 16. return true
        ProductDetailsPage --> Actor: 17. message("Review submitted")
    else insert failed
        CreateReviewHandler --> ReviewController: 14.1 return false
        ReviewController --> ProductDetailsPage: 14.2 return false
        ProductDetailsPage --> Actor: 14.3 message("Failed to submit review")
    end
else sku not found
    CreateReviewHandler --> ReviewController: 9.1 return false
    deactivate CreateReviewHandler
    ReviewController --> ProductDetailsPage: 9.2 return false
    deactivate ReviewController
    ProductDetailsPage --> Actor: 9.3 message("Unable to find product for review")
    deactivate ProductDetailsPage
    deactivate Actor
end

@enduml

