@startuml UC7_view_product_details
actor Actor
boundary ProductDetailsPage
control CatalogController
control GetIphoneModelBySlugHandler
control IphoneModelRepository
control SkuRepository
control BranchRepository
database MongoDB

Actor -> ProductDetailsPage: 1. clickOnItem(slug)
activate Actor
activate ProductDetailsPage

ProductDetailsPage -> CatalogController: 2. getProductModelBySlug(slug)
activate CatalogController

CatalogController -> GetIphoneModelBySlugHandler: 3. getProductModelBySlug(slug)
activate GetIphoneModelBySlugHandler

GetIphoneModelBySlugHandler -> IphoneModelRepository: 4. getByFilter(Slug)
activate IphoneModelRepository
IphoneModelRepository -> MongoDB: 5. find(Slug)
activate MongoDB
MongoDB --> IphoneModelRepository: 6. return(productModel)
deactivate MongoDB
IphoneModelRepository --> GetIphoneModelBySlugHandler: 7. return(productModel)
deactivate IphoneModelRepository

alt product exists
    GetIphoneModelBySlugHandler -> SkuRepository: 8. GetAll(productModel.Id)
    activate SkuRepository
    SkuRepository -> MongoDB: 9. find(productModel.Id)
    activate MongoDB
    MongoDB --> SkuRepository: 10. return(skus)
    deactivate MongoDB
    SkuRepository --> GetIphoneModelBySlugHandler: 11. return(skus)
    deactivate SkuRepository
    GetIphoneModelBySlugHandler -> GetIphoneModelBySlugHandler: 12. Group SKUs by BranchId
    loop foreach BranchId in skusByBranch
        GetIphoneModelBySlugHandler -> BranchRepository: 13. GetById(branchId)
        activate BranchRepository
        BranchRepository -> MongoDB: 14. getById(branchId)
        activate MongoDB
        MongoDB --> BranchRepository: 15. return(branch)
        deactivate MongoDB
        BranchRepository --> GetIphoneModelBySlugHandler: 16. return(branch)
        deactivate BranchRepository
    end
    
    GetIphoneModelBySlugHandler -> GetIphoneModelBySlugHandler: 17. ToResponse(model, skusByBranch)
    GetIphoneModelBySlugHandler --> CatalogController: 18. return(IphoneModelDetailsResponse)
    CatalogController --> ProductDetailsPage: 19. return(IphoneModelDetailsResponse)
    ProductDetailsPage --> Actor: 20. display("Product details with branches and SKUs")

    opt add to cart
        Actor -> ProductDetailsPage: 21. clickOnAddToCart()
        ref over ProductDetailsPage: sd: thêm vào giỏ hàng
    end
else product does not exist
    GetIphoneModelBySlugHandler --> CatalogController: 7.1 return Errors.Product.NotFound
    deactivate GetIphoneModelBySlugHandler
    CatalogController --> ProductDetailsPage: 7.2 return Errors.Product.NotFound
    deactivate CatalogController
    ProductDetailsPage --> Actor: 7.3 display("Product not found")
    deactivate ProductDetailsPage
    deactivate Actor
end

@enduml

