@startuml UC10_manage_cart
actor Actor
boundary CartPage
boundary CheckoutPage
control BasketController
control GetBasketQueryHandler
control UserHttpContext
control BasketRepository
control DiscountProtoService
database DB

Actor -> CartPage: 1. open(cart?couponCode)
activate Actor
activate CartPage

CartPage -> BasketController: 2. getBasket(query)
activate BasketController

BasketController -> GetBasketQueryHandler: 3. getBasket(query)
activate GetBasketQueryHandler

GetBasketQueryHandler -> UserHttpContext: 4. GetUserEmail()
activate UserHttpContext
UserHttpContext --> GetBasketQueryHandler: 5. return userEmail
deactivate UserHttpContext

GetBasketQueryHandler -> BasketRepository: 6. GetBasketAsync(userEmail)
activate BasketRepository
BasketRepository -> DB: 7. LoadAsync(userEmail)
activate DB
DB --> BasketRepository: 8. return(shoppingCart)
deactivate DB
BasketRepository --> GetBasketQueryHandler: 9. return Result(shoppingCart)
deactivate BasketRepository

alt has items
    GetBasketQueryHandler -> GetBasketQueryHandler: 10. FilterOutEventItems()

    opt coupon code provided
        GetBasketQueryHandler -> DiscountProtoService: 11. GetCouponByCodeGrpcAsync(couponCode)
        activate DiscountProtoService
        DiscountProtoService --> GetBasketQueryHandler: 12. return CouponModel
        deactivate DiscountProtoService

        alt coupon found and available
            GetBasketQueryHandler -> GetBasketQueryHandler: 13. Select items where IsSelected == true
            GetBasketQueryHandler -> GetBasketQueryHandler: 14. Convert to EfficientCart format
            GetBasketQueryHandler -> GetBasketQueryHandler: 15. ConvertGrpcEnumToNormalEnum(discountType)
            GetBasketQueryHandler -> GetBasketQueryHandler: 16. CalculateEfficientCart(beforeCart, discountType, discountValue, maxDiscountAmount)
            GetBasketQueryHandler -> GetBasketQueryHandler: 17. Update ShoppingCart discount properties from EfficientCart
            loop for each selected item
                GetBasketQueryHandler -> GetBasketQueryHandler: 18. Create PromotionCoupon(promotionId, promotionType, discountType, discountValue)
                GetBasketQueryHandler -> GetBasketQueryHandler: 19. ApplyCoupon(item, promotionCoupon)
                GetBasketQueryHandler -> GetBasketQueryHandler: 20. Update item DiscountAmount from EfficientCart
            end
        else coupon not found
            GetBasketQueryHandler --> BasketController: 12.1 return Errors.Discount.CouponNotFound
            BasketController --> CartPage: 12.2 return Errors.Discount.CouponNotFound
            CartPage --> Actor: 12.3 message("Coupon not found")
        end
    end

    GetBasketQueryHandler -> GetBasketQueryHandler: 21. ToResponse(shoppingCart)
    GetBasketQueryHandler --> BasketController: 22. return GetBasketResponse(items, totalAmount, discountAmount)
    BasketController --> CartPage: 23. return GetBasketResponse
    CartPage --> Actor: 24. display(Cart with totals)
    opt update quantity
        Actor -> CartPage: 25. updateQuantity(index, quantity)
        ref over CartPage: sd: thêm vào giỏ hàng
    end

    opt process to checkout
        Actor -> CartPage: 26. clickOnCheckout()
        CartPage -> CheckoutPage: 27. navigate()
        activate CheckoutPage
        deactivate CheckoutPage
        ref over CheckoutPage: sd: thanh toán
    end
else no items in cart
    GetBasketQueryHandler --> BasketController: 9.1 return GetBasketResponse(empty)
    deactivate GetBasketQueryHandler
    BasketController --> CartPage: 9.2 return GetBasketResponse(empty)
    deactivate BasketController
    CartPage --> Actor: 9.3 display(Empty cart)
    deactivate CartPage
    deactivate Actor
end

@enduml

