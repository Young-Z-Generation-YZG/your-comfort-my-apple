@startuml UC15_checkout
actor Actor
boundary CheckoutPage
control CartController
control CheckoutBasketHandler
control UserHttpContext
control BasketRepository
control DiscountProtoService
control PublishEndpoint
control VnpayProvider
control MomoProvider
control HttpContextAccessor

Actor -> CheckoutPage: checkout(discountCode?, paymentMethod, shippingAddress)
activate Actor
activate CheckoutPage

CheckoutPage -> CartController: checkout(command)
activate CartController

CartController -> CheckoutBasketHandler: checkout(command)
activate CheckoutBasketHandler

CheckoutBasketHandler -> UserHttpContext: GetUserEmail()
activate UserHttpContext
UserHttpContext --> CheckoutBasketHandler: userEmail
deactivate UserHttpContext

CheckoutBasketHandler -> UserHttpContext: GetUserId()
activate UserHttpContext
UserHttpContext --> CheckoutBasketHandler: userId
deactivate UserHttpContext

CheckoutBasketHandler -> BasketRepository: GetBasket(userEmail)
activate BasketRepository
BasketRepository --> CheckoutBasketHandler: Result(shoppingCart)
deactivate BasketRepository

alt basket empty or no items
    CheckoutBasketHandler --> CartController: return Errors.Basket.BasketEmpty
    CartController --> CheckoutPage: return Errors.Basket.BasketEmpty
    CheckoutPage --> Actor: message("Basket is empty")
else has items
    alt no items selected
        CheckoutBasketHandler --> CartController: return Errors.Basket.NotSelectedItems
        CartController --> CheckoutPage: return Errors.Basket.NotSelectedItems
        CheckoutPage --> Actor: message("No items selected for checkout")
    else proceed
        alt contains event items
            CheckoutBasketHandler -> CheckoutBasketHandler: FilterEventItems()
            note over CheckoutBasketHandler: Capture event promotion data\n(id, type, discountType, value, amount)
        else regular items
            CheckoutBasketHandler -> CheckoutBasketHandler: FilterOutEventItemsAndSelected()

            opt discount code provided
                CheckoutBasketHandler -> DiscountProtoService: GetCouponByCodeGrpc(discountCode)
                activate DiscountProtoService
                DiscountProtoService --> CheckoutBasketHandler: CouponModel | NotFound
                deactivate DiscountProtoService

                alt coupon not found
                    CheckoutBasketHandler --> CartController: return Errors.Discount.CouponNotFound
                    CartController --> CheckoutPage: return Errors.Discount.CouponNotFound
                    CheckoutPage --> Actor: message("Coupon not found")
                else coupon valid
                    CheckoutBasketHandler -> CheckoutBasketHandler: Select items IsSelected == true
                    CheckoutBasketHandler -> CheckoutBasketHandler: Calculate totalCartValue
                    CheckoutBasketHandler -> CheckoutBasketHandler: Convert discount type
                    CheckoutBasketHandler -> CheckoutBasketHandler: Calculate calculatedDiscount
                    CheckoutBasketHandler -> CheckoutBasketHandler: Apply max discount cap
                    note over CheckoutBasketHandler: Store cart-level promotion data\nfor integration event
                    loop for each selected item
                        CheckoutBasketHandler -> CheckoutBasketHandler: Proportional item discount
                        CheckoutBasketHandler -> CheckoutBasketHandler: ApplyCoupon(item)
                    end
                end
            end

            CheckoutBasketHandler -> CheckoutBasketHandler: Prepare BasketCheckoutIntegrationEvent
            CheckoutBasketHandler -> PublishEndpoint: Publish(integrationEvent)
            activate PublishEndpoint
            PublishEndpoint --> CheckoutBasketHandler: published
            deactivate PublishEndpoint

            CheckoutBasketHandler -> BasketRepository: DeleteSelectedItemsBasket(userEmail)
            activate BasketRepository
            BasketRepository --> CheckoutBasketHandler: done
            deactivate BasketRepository

            alt paymentMethod == VNPAY
                CheckoutBasketHandler -> HttpContextAccessor: HttpContext
                activate HttpContextAccessor
                HttpContextAccessor --> CheckoutBasketHandler: context
                deactivate HttpContextAccessor

                CheckoutBasketHandler -> VnpayProvider: CreatePaymentUrl(model, context)
                activate VnpayProvider
                VnpayProvider --> CheckoutBasketHandler: paymentUrl
                deactivate VnpayProvider

                alt invalid url
                    CheckoutBasketHandler --> CartController: return Errors.Payment.VnpayPaymentUrlInvalid
                    CartController --> CheckoutPage: return Errors.Payment.VnpayPaymentUrlInvalid
                    CheckoutPage --> Actor: message("Payment URL invalid")
                else ok
                    CheckoutBasketHandler --> CartController: return CheckoutBasketResponse(orderId, items, paymentUrl)
                    CartController --> CheckoutPage: return CheckoutBasketResponse
                    CheckoutPage --> Actor: redirect(paymentUrl)
                end
            else paymentMethod == MOMO
                CheckoutBasketHandler -> MomoProvider: CreatePaymentUrl(model)
                activate MomoProvider
                MomoProvider --> CheckoutBasketHandler: momoPaymentUrl
                deactivate MomoProvider

                alt error code != 0
                    CheckoutBasketHandler --> CartController: return Errors.Payment.MomoPaymentUrlInvalid
                    CartController --> CheckoutPage: return Errors.Payment.MomoPaymentUrlInvalid
                    CheckoutPage --> Actor: message("Payment URL invalid")
                else ok
                    CheckoutBasketHandler --> CartController: return CheckoutBasketResponse(orderId, items, momoPayUrl)
                    CartController --> CheckoutPage: return CheckoutBasketResponse
                    CheckoutPage --> Actor: redirect(momoPayUrl)
                end
            else paymentMethod == COD
                CheckoutBasketHandler --> CartController: return CheckoutBasketResponse(orderId, items, orderDetailsUrl)
                CartController --> CheckoutPage: return CheckoutBasketResponse
                CheckoutPage --> Actor: redirect(orderDetailsUrl)
            else invalid method
                CheckoutBasketHandler --> CartController: return Errors.Payment.Invalid
                deactivate CheckoutBasketHandler
                CartController --> CheckoutPage: return Errors.Payment.Invalid
                deactivate CartController
                CheckoutPage --> Actor: message("Invalid payment method")
                deactivate CheckoutPage
                deactivate Actor
            end
        end
    end
end

@enduml

