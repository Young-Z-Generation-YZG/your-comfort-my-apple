---
globs:
    - "Services/Catalog/**"
    - "!**/node_modules/**"
    - "!**/.next/**"
AI:
    alwaysApply: true
---

# Catalog Service Project Rules

These rules apply **only** to the Catalog microservice located in `Services/Catalog`.

## Architecture Pattern

-   **Clean Architecture** with Domain-Driven Design (DDD):
    -   **Domain Layer** (`YGZ.Catalog.Domain`): Core business entities (Category, ProductModel, IphoneModel, Review, Tenant, SKU, etc.), value objects, domain events, domain errors, and domain logic. No dependencies on other layers.
    -   **Application Layer** (`YGZ.Catalog.Application`): Use cases, commands, queries, handlers (CQRS), validators, and application services. Depends only on Domain.
    -   **Infrastructure Layer** (`YGZ.Catalog.Infrastructure`): Data access (MongoDB), Cloudinary integration, external services. Implements interfaces defined in Application/Domain.
    -   **API Layer** (`YGZ.Catalog.Api`): Controllers, request/response DTOs, middleware, dependency injection setup. Entry point for HTTP/gRPC.

## CQRS Pattern

-   Use **MediatR** for CQRS implementation:
    -   Commands: Implement `ICommand<TResponse>` from `YGZ.BuildingBlocks.Shared.Abstractions.CQRS`
    -   Queries: Implement `IQuery<TResponse>` from `YGZ.BuildingBlocks.Shared.Abstractions.CQRS`
    -   Handlers: Implement `ICommandHandler<TCommand, TResponse>` or `IQueryHandler<TQuery, TResponse>`
-   Commands and queries must return `Result<TResponse>` from `YGZ.BuildingBlocks.Shared.Abstractions.Result`
-   Organize by feature: `Application/{Feature}/Commands/{CommandName}/` and `Application/{Feature}/Queries/{QueryName}/`
-   Each command/query should be in its own folder containing: `{Command/Query}Name.cs`, `{Command/Query}NameHandler.cs`, and optionally `{Command/Query}NameValidator.cs`

## Result Pattern

-   All handlers must return `Result<TResponse>`:
    -   Use `Result.Success(data)` for successful operations
    -   Use `Result.Failure(Error)` or `Result.ValidationFailure(ValidationError[])` for failures
-   Controllers use `result.Match(onSuccess: Ok, onFailure: HandleFailure)` pattern
-   Never throw exceptions from application layer; use Result pattern instead

## Naming Conventions

### Commands

-   **Pattern**: `{Action}{Entity}Command` (e.g., `CreateCategoryCommand`, `UpdateCategoryCommand`, `CreateProductModelCommand`, `CreateReviewCommand`, `UpdateInventoryCommand`)
-   **Handler**: `{CommandName}Handler` (e.g., `CreateCategoryHandler`, `UpdateCategoryHandler`)
-   **Validator**: `{CommandName}Validator` (e.g., `CreateCategoryValidator`, `UpdateCategoryValidator`)
-   **Location**: `Application/{Feature}/Commands/{CommandName}/`
-   Examples:
    -   `Application/Categories/Commands/CreateCategory/CreateCategoryCommand.cs`
    -   `Application/ProductModels/Commands/CreateProductModel/CreateProductModelCommand.cs`
    -   `Application/Reviews/Commands/CreateReview/CreateReviewCommand.cs`

### Queries

-   **Pattern**: `Get{Entity}Query` or `Get{Entity}{Detail}Query` (e.g., `GetCategoriesQuery`, `GetCategoryDetailsQuery`, `GetProductModelsQuery`, `GetProductModelDetailsQuery`, `GetReviewsQuery`)
-   **Handler**: `{QueryName}Handler` or `Get{Entity}QueryHandler` (e.g., `GetCategoriesHandler`, `GetCategoryDetailsHandler`)
-   **Location**: `Application/{Feature}/Queries/{QueryName}/`
-   Examples:
    -   `Application/Categories/Queries/GetCategories/GetCategoriesQuery.cs`
    -   `Application/Categories/Queries/GetCategoryDetails/GetCategoryDetailsQuery.cs`
    -   `Application/ProductModels/Queries/GetProductModels/GetProductModelsQuery.cs`

### Controllers

-   **Pattern**: `{Entity}Controller` (e.g., `CategoryController`, `ProductModelController`, `ReviewController`, `InventoryController`, `PromotionController`, `TenantController`, `IphoneController`, `UploadFileController`)
-   **Location**: `Api/Controllers/`
-   **Route Pattern**: `[Route("api/v{version:apiVersion}/{resource}")]` (e.g., `api/v1/categories`, `api/v1/product-models`, `api/v1/reviews`)
-   Must inherit from `ApiController` base class
-   Use `[OpenApiTag("{tag}", Description = "...")]` for Swagger documentation

### Request DTOs

-   **Pattern**: `{Action}{Entity}Request` (e.g., `CreateCategoryRequest`, `UpdateCategoryRequest`, `CreateProductModelRequest`, `CreateReviewRequest`)
-   **Location**: `Api/Contracts/{Feature}Request/` (e.g., `Api/Contracts/CategoryRequest/CreateCategoryRequest.cs`, `Api/Contracts/ReviewRequest/CreateReviewRequest.cs`)
-   Use `required` keyword for required properties (C# 11+)
-   Use `[JsonPropertyName("snake_case")]` for JSON serialization naming if needed
-   Include example classes for Swagger: `{RequestName}Example.cs` (e.g., `CreateCategoryRequestExample.cs`)

### Response DTOs

-   **Pattern**: `{Entity}Response` or `{Action}{Entity}Response` (e.g., `CategoryResponse`, `ProductModelResponse`, `ReviewResponse`)
-   **Location**: Prefer shared contracts from `YGZ.BuildingBlocks.Shared.Contracts` when possible
-   For service-specific responses: Use shared contracts from `YGZ.BuildingBlocks.Shared.Contracts.Catalogs` or `YGZ.BuildingBlocks.Shared.Contracts.Products`

### Domain Entities

-   **Pattern**: `{Entity}` (e.g., `Category`, `ProductModel`, `IphoneModel`, `Review`, `Tenant`, `SKU`, `Branch`)
-   **Location**: `Domain/{Feature}/` (e.g., `Domain/Categories/Category.cs`, `Domain/Products/ProductModels/ProductModel.cs`, `Domain/Products/Iphone/IphoneModel.cs`)
-   Use value objects for domain concepts (e.g., `CategoryId`, `ModelId`, `Slug`, `Color`, `Storage`, `Image`, `Rating`, `SkuCode`)
-   Entities should implement `IAuditable` for audit fields and `ISoftDelete` for soft-delete support
-   Use `[BsonCollection("CollectionName")]` attribute for MongoDB collection mapping
-   Use `[BsonElement("field_name")]` for MongoDB field mapping

### Domain Value Objects

-   **Pattern**: `{Concept}` (e.g., `CategoryId`, `ModelId`, `Slug`, `Color`, `Storage`, `Image`, `Rating`, `RatingStar`, `SkuCode`, `AverageRating`)
-   **Location**: `Domain/{Feature}/ValueObjects/` or `Domain/Products/Common/ValueObjects/` for shared value objects
-   Inherit from `ValueObject` base class
-   Use `Create` static factory methods for creation

### Domain Events

-   **Pattern**: `{Entity}{Action}DomainEvent` (e.g., `ProductModelCreatedDomainEvent`, `ReviewCreatedDomainEvent`, `ReviewUpdatedDomainEvent`, `ReviewDeletedDomainEvent`, `TenantCreatedDomainEvent`)
-   **Location**: `Domain/{Feature}/Events/` (e.g., `Domain/Products/ProductModels/Events/ProductModelCreatedDomainEvent.cs`)
-   Implement `IDomainEvent` interface

### Domain Errors

-   **Pattern**: `Errors.{Entity}` or `Error.{Entity}` (e.g., `Errors.Category`, `Error.ProductModel`, `Error.Inventory`, `Error.Review`, `Error.Tenant`)
-   **Location**: `Domain/Core/Errors/`
-   Use static methods to create error instances

### Enums

-   **Pattern**: `E{Name}` prefix (e.g., `EProductStatus`, `EInventoryStatus`, `EReviewStatus`)
-   **Location**: `Domain/Core/Enums/` or `Domain/{Feature}/Enums/`

## Feature Organization

-   **Categories**: Category management features (create, update, get categories)
    -   Commands: `Application/Categories/Commands/`
    -   Queries: `Application/Categories/Queries/`
    -   Contracts: `Api/Contracts/CategoryRequest/`
-   **ProductModels**: Product model management features
    -   Commands: `Application/ProductModels/Commands/`
    -   Queries: `Application/ProductModels/Queries/`
    -   Events: `Application/ProductModels/Events/`
    -   Contracts: `Api/Contracts/ProductModelRequest/`
-   **Iphone**: iPhone-specific product features
    -   Commands: `Application/Iphone/Commands/`
    -   Queries: `Application/Iphone/Queries/`
    -   Events: `Application/Iphone/Events/`
    -   Contracts: `Api/Contracts/IphoneRequest/`
-   **Inventory**: Inventory management features (SKU management, stock updates)
    -   Commands: `Application/Inventory/Commands/`
    -   Queries: `Application/Inventory/Queries/`
    -   Events: `Application/Inventory/Events/`
    -   Contracts: `Api/Contracts/InventoryRequest/`
-   **Reviews**: Product review management features
    -   Commands: `Application/Reviews/Commands/`
    -   Queries: `Application/Reviews/Queries/`
    -   Events: `Application/Reviews/Events/`
    -   Contracts: `Api/Contracts/ReviewRequest/`
-   **Promotions**: Promotion and discount management features
    -   Queries: `Application/Promotions/Queries/`
    -   Events: `Application/Promotions/Events/`
    -   EventItems: `Application/Promotions/EventItems/`
    -   Contracts: `Api/Contracts/PromotionRequest/`
-   **Tenants**: Tenant management features
    -   Commands: `Application/Tenants/Commands/`
    -   Queries: `Application/Tenants/Queries/`
    -   Events: `Application/Tenants/Events/`
    -   Contracts: `Api/Contracts/TenantRequest/`
-   **Cloudinary**: Image upload and management features
    -   Commands: `Application/Cloudinary/Commands/`
    -   Queries: `Application/Cloudinary/Queries/`
    -   Contracts: `Api/Contracts/UploadImageRequest/`
-   **Common**: Shared commands, queries, mappings, and validators
    -   Commands: `Application/Common/Commands/`
    -   Mappings: `Application/Common/Mappings/`
    -   Validators: `Application/Common/Validators/`
    -   Contracts: `Api/Contracts/Common/`

## Cloudinary Integration

-   Use **Cloudinary** for image upload and management
-   Image uploader abstraction: `Application/Abstractions/Uploading/`
-   Image uploader implementation: `Infrastructure/Services/ImageUploader/`
-   Cloudinary settings: `Infrastructure/Settings/CloudinarySettings.cs`
-   Image-related mappings: `Api/Mappings/CloudinaryImageMapping.cs`, `Api/Mappings/ImageMapping.cs`

## Multi-Tenancy

-   Use `X-TenantId` header for tenant isolation
-   Implement `ITenantHttpContext` from BuildingBlocks to access tenant context
-   Use `TenantId` value object for type-safe tenant identification
-   Apply tenant filtering in queries automatically via infrastructure layer
-   Tenant-specific pricing: `Domain/Tenants/Entities/IphoneSkuPrice.cs`

## Validation

-   Use **FluentValidation** for request validation
-   Validator naming: `{CommandName}Validator`
-   Location: Same folder as command (e.g., `Application/Categories/Commands/CreateCategory/CreateCategoryValidator.cs`)
-   Register validators in Application layer DI setup
-   Use `ValidationPipelineBehavior` from BuildingBlocks for automatic validation
-   Validation errors are returned via `Result.ValidationFailure(ValidationError[])`

## Database

-   Use **MongoDB** for data persistence
-   Implement repository pattern in Infrastructure layer
-   Repository location: `Infrastructure/Persistence/Repositories/`
-   MongoDB context: `Infrastructure/Persistence/Context/`
-   MongoDB configurations: `Infrastructure/Persistence/Configurations/`
-   Use `IAuditable` interface for entities that need audit fields (`CreatedAt`, `UpdatedAt`, `UpdatedBy`)
-   Use `ISoftDelete` interface for soft-delete support (`IsDeleted`, `DeletedAt`, `DeletedBy`)
-   Use `[BsonCollection("CollectionName")]` attribute for collection mapping
-   Use `[BsonElement("field_name")]` for field mapping (snake_case convention)
-   MongoDB interceptors: `Infrastructure/Persistence/Interceptors/`
-   Seed data: `Infrastructure/Persistence/Seeds/`

## Code Style

-   Use **C# 12** features where appropriate
-   Follow C# naming conventions:
    -   Classes: PascalCase
    -   Methods: PascalCase
    -   Properties: PascalCase
    -   Private fields: `_camelCase`
    -   Parameters: camelCase
-   Use file-scoped namespaces: `namespace YGZ.Catalog.{Layer}.{Feature};`
-   Use primary constructors where appropriate (C# 12)
-   Use `var` for local variables when type is obvious
-   Use expression-bodied members when appropriate
-   Use `sealed record` for commands and queries
-   Use `required` keyword for required properties in DTOs and entities

## Controllers

-   All controllers inherit from `ApiController` base class
-   Use MediatR `ISender` to send commands/queries:
    ```csharp
    var result = await _sender.Send(command, cancellationToken);
    return result.Match(onSuccess: Ok, onFailure: HandleFailure);
    ```
-   Use Mapster `IMapper` for request-to-command/query mapping
-   Route pattern: `[Route("api/v{version:apiVersion}/{resource}")]`
-   Use API versioning attributes: `[ApiVersion(1)]`
-   Use `[OpenApiTag]` for Swagger documentation
-   Use `CancellationToken` in all async controller methods
-   Use `[AllowAnonymous]` only when explicitly required (e.g., public product listings)
-   Use `[ProtectedResource("resource")]` attribute for resource-based authorization when needed

## Dependency Injection

-   Use extension methods for layer registration:
    -   `AddPresentationLayer()` in API layer (`DependencyInjection.cs`)
    -   `AddApplicationLayer(configuration)` in Application layer (`DependencyInjection.cs`)
    -   `AddInfrastructureLayer(configuration)` in Infrastructure layer (`DependencyInjection.cs`)
-   Register MediatR handlers: `services.AddMediatR(cfg => cfg.RegisterServicesFromAssembly(typeof(ApplicationAssembly).Assembly))`
-   Register FluentValidation validators: `services.AddFluentValidation(cfg => cfg.RegisterValidatorsFromAssembly(...))`
-   Register Mapster mappings: `services.AddSingleton<IMapper>(new Mapper(...))`
-   Mappings location: `Api/Mappings/` (e.g., `ColorMapping.cs`, `ImageMapping.cs`, `ModelMapping.cs`, `StorageMapping.cs`)

## Error Handling

-   Use `GlobalExceptionHandler` from BuildingBlocks for unhandled exceptions
-   Use `ApplicationProblemDetailsFactory` for consistent error responses
-   Controllers use `HandleFailure` method from `ApiController` base class
-   Never expose internal exceptions to clients; map to user-friendly errors
-   Use domain errors from `Domain/Core/Errors/` for business logic failures

## Logging

-   Use **Serilog** for structured logging
-   Use `ILogger<T>` with dependency injection
-   Configure Serilog via `AddSerilogExtension` extension method
-   Use **OpenTelemetry** for distributed tracing

## Health Checks

-   Register health checks in `Program.cs`
-   Map health endpoint: `app.MapHealthChecks("/health", new HealthCheckOptions { ... })`
-   Include MongoDB health check

## gRPC Support

-   Define `.proto` files in `Api/Protos/` directory (e.g., `catalog.proto`)
-   Implement gRPC services: `public class CatalogRpcService : CatalogService.CatalogServiceBase`
-   Register gRPC: `services.AddGrpc()` and `app.MapGrpcService<CatalogRpcService>()`
-   Use `ConvertGrpcEnumToNormalEnum` and `ConvertNormalEnumToGrpcEnum` utilities from BuildingBlocks
-   gRPC service location: `Api/GrpcServices/`

## Caching

-   Use **Redis** for distributed caching when needed
-   Access via `StackExchange.Redis.IConnectionMultiplexer`
-   Use cache key prefixes from `CacheKeyPrefixConstants` in BuildingBlocks
-   Clear cache on data mutations (categories, products, etc.)

## Security

-   Never commit secrets or connection strings
-   Use `IConfiguration` and `appsettings.json` for configuration
-   Use environment-specific `appsettings.{Environment}.json` files
-   Validate all inputs; never trust client data
-   Use HTTPS in production
-   Secure Cloudinary credentials and MongoDB connection strings
-   Use `X-TenantId` header validation for multi-tenancy

## Performance

-   Use async/await for all I/O operations
-   Use `CancellationToken` throughout async chains
-   Implement pagination for list endpoints
-   Use caching for frequently accessed data (categories, product listings)
-   Use `ConfigureHttpClientDefaults` with resilience handlers for external HTTP calls (Cloudinary)
-   Optimize MongoDB queries with proper indexing

## Code Organization

-   Group related files by feature, not by type
-   Keep controllers thin; business logic belongs in Application layer
-   Use extension methods for cross-cutting concerns
-   Keep domain entities pure; no infrastructure dependencies
-   Use value objects for domain concepts (e.g., `CategoryId`, `Slug`, `Color`, `Storage`, `Rating`)
-   Each command/query in its own folder with handler and optional validator
-   Domain events should be raised from domain entities, not from application handlers

## Common Patterns

-   **Pipeline Behaviors**: Use `ValidationPipelineBehavior` and `RequestLoggingPipelineBehavior` from BuildingBlocks
-   **Mapping**: Use Mapster for DTO-to-command/query mapping (location: `Api/Mappings/`)
-   **Pagination**: Use `PaginationResponse<T>` and `PaginationLinks` from BuildingBlocks
-   **Filtering/Sorting**: Use query builders and expression builders from BuildingBlocks utilities
-   **Domain Events**: Raise domain events from entities, handle in application layer event handlers

## Catalog-Specific Features

-   **Product Models**: Support product model creation with variants (colors, storage options)
-   **iPhone Models**: Special handling for iPhone products with SKU pricing
-   **Inventory Management**: Track SKU inventory levels per tenant/branch
-   **Reviews**: Support product reviews with ratings and customer information
-   **Promotions**: Support promotion events and reserved quantities
-   **Image Management**: Upload and manage product images via Cloudinary
-   **Category Hierarchy**: Support parent-child category relationships
-   **Slug Generation**: Automatic slug generation for SEO-friendly URLs
-   **Rating Calculation**: Automatic average rating calculation from reviews
-   **Tenant Pricing**: Tenant-specific SKU pricing management

## MongoDB Conventions

-   Use snake_case for MongoDB field names (`[BsonElement("field_name")]`)
-   Use PascalCase for C# properties
-   Use `[BsonCollection("CollectionName")]` for collection mapping
-   Use `[BsonIgnoreExtraElements]` to ignore unknown fields
-   Use `ObjectId` or string IDs based on domain requirements
-   Use MongoDB BSON serialization attributes appropriately
