events {
    worker_connections 1024;
}

http {
    # Upstream definitions for better load balancing and health checks
    upstream gateway_backend {
        server ygz.gateways.yarp:8080;
    }

    upstream client_frontend {
        server ygz.client.web:3000;
    }

    upstream admin_frontend {
        server ygz.admin.web:3000;
    }

    upstream keycloak_backend {
        server ygz.keycloak.server:17070;
    }

    # HTTP → HTTPS redirection (for local/dev and domain usage)
    server {
        listen 80;
        listen [::]:80;
        server_name localhost ybzone.io.vn admin.ybzone.io.vn;

        return 301 https://$host$request_uri;
    }

    # HTTPS server for main site (ybzone.io.vn)
    server {
        listen 443 ssl http2;
        listen [::]:443 ssl http2;
        server_name ybzone.io.vn;

        # SSL certificates mounted from ./ssl via docker-compose
        ssl_certificate     /etc/letsencrypt/live/ybzone.io.vn/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/ybzone.io.vn/privkey.pem;

        # SSL configuration
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers on;

        # API Gateway routes - route all API calls through YARP gateway
        # Frontend should call: /api/identity-services/..., /api/catalog-services/..., etc.
        # Nginx strips /api/ prefix and passes to gateway: /identity-services/..., /catalog-services/..., etc.
        location /api/ {
            proxy_pass http://gateway_backend/;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }

        # Keycloak authentication routes
        location /auth/ {
            proxy_pass http://keycloak_backend/;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            proxy_buffering off;
        }

        # Default route → client app
        location / {
            proxy_pass http://client_frontend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            proxy_cache_bypass $http_upgrade;
        }
    }

    # HTTPS server for admin site (admin.ybzone.io.vn)
    server {
        listen 443 ssl http2;
        listen [::]:443 ssl http2;
        server_name admin.ybzone.io.vn;

        ssl_certificate     /etc/letsencrypt/live/ybzone.io.vn/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/ybzone.io.vn/privkey.pem;

        # SSL configuration
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers on;

        # API Gateway routes for admin panel
        # Frontend should call: /api/identity-services/..., /api/catalog-services/..., etc.
        # Nginx strips /api/ prefix and passes to gateway: /identity-services/..., /catalog-services/..., etc.
        location /api/ {
            proxy_pass http://gateway_backend/;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }

        # Keycloak authentication routes
        location /auth/ {
            proxy_pass http://keycloak_backend/;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            proxy_buffering off;
        }

        # Default route → admin app
        location / {
            proxy_pass http://admin_frontend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            proxy_cache_bypass $http_upgrade;
        }
    }
}


